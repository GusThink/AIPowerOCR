<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIPowerOCR: Ekstrak Teks dari Gambar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js" defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Naskh+Arabic:wght@400;700&family=Inter:wght@400;500;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; }
        .font-naskh { font-family: 'Noto Naskh Arabic', serif; }

        :root {
            --bg-primary-rgb: 15, 23, 42;
            --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-tertiary: #334155;
            --text-primary: #f1f5f9; --text-secondary: #94a3b8; --accent-color: #22d3ee;
            --border-color: #475569; --btn-accent-bg: linear-gradient(to right, #22d3ee, #0ea5e9);
        }
        .light-theme {
            --bg-primary-rgb: 241, 245, 249;
            --bg-primary: #f1f5f9; --bg-secondary: #ffffff; --bg-tertiary: #f8fafc;
            --text-primary: #0f172a; --text-secondary: #475569; --accent-color: #0891b2;
            --border-color: #e2e8f0; --btn-accent-bg: linear-gradient(to right, #06b6d4, #0284c7);
        }

        .bg-primary { background-color: var(--bg-primary); }
        .bg-secondary { background-color: var(--bg-secondary); }
        .bg-tertiary { background-color: var(--bg-tertiary); }
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .text-accent { color: var(--text-accent); }
        .border-custom { border-color: var(--border-color); }
        
        #device-preview-container {
            transition: width 0.5s ease, height 0.5s ease, border-radius 0.5s ease, box-shadow 0.5s ease;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            overflow: hidden; border: 8px solid #333; background-color: var(--bg-primary); position: relative;
        }
        #content-container { overflow-y: auto; }
        .pc-view { width: 100%; height: 85vh; border-radius: 1rem; }
        .tablet-view { width: 768px; height: 1024px; max-width: 100%; max-height: 85vh; border-radius: 1.5rem; }
        .mobile-view { width: 375px; height: 667px; max-width: 100%; max-height: 85vh; border-radius: 2rem; }

        #scan-overlay .scan-line {
            width: 100%; height: 4px;
            background: linear-gradient(90deg, transparent, var(--accent-color), transparent);
            box-shadow: 0 0 15px var(--accent-color);
            border-radius: 5px; position: absolute; top: 0; left: 0;
            animation: scan 2s infinite ease-in-out;
        }
        @keyframes scan {
            0% { top: 0; } 50% { top: 100%; } 100% { top: 0; }
        }

        .glass-menubar {
            background-color: rgba(var(--bg-primary-rgb), 0.7);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
        }
        
        #ocr-result:focus {
            outline: 2px solid var(--accent-color);
            border-radius: 8px;
        }
    </style>
</head>
<body class="bg-primary text-primary">

    <header class="glass-menubar sticky top-0 z-50 py-2 px-4 sm:px-6 md:px-8 border-b border-custom">
        <div class="max-w-7xl mx-auto grid grid-cols-3 items-center">
            <div class="w-10"></div> 
            <div class="flex items-center gap-2 justify-self-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-accent">
                    <path d="M3 7V5a2 2 0 0 1 2-2h2"></path><path d="M17 3h2a2 2 0 0 1 2 2v2"></path><path d="M21 17v2a2 2 0 0 1-2 2h-2"></path><path d="M7 21H5a2 2 0 0 1-2-2v-2"></path><path d="M7 12h10"></path>
                </svg>
                <h1 class="text-xl font-bold text-primary">AIPower<span class="text-accent">OCR</span></h1>
            </div>
            <div class="relative justify-self-end">
                <button id="menu-btn" class="p-2 rounded-full text-primary bg-tertiary/50 hover:bg-tertiary transition duration-300 focus:outline-none" title="Opsi">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg>
                </button>
                <div id="dropdown-menu" class="hidden absolute right-0 mt-2 w-56 bg-secondary rounded-lg shadow-lg border border-custom z-50 origin-top-right">
                    <div class="py-1">
                        <button id="menu-device-toggle" class="w-full text-left flex items-center gap-3 px-4 py-2 text-sm text-primary hover:bg-tertiary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line></svg>
                            Ganti Tampilan
                        </button>
                        <button id="menu-theme-toggle" class="w-full text-left flex items-center gap-3 px-4 py-2 text-sm text-primary hover:bg-tertiary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                            Ganti Tema
                        </button>
                        <div class="border-t border-custom my-1"></div>
                        <button id="menu-api-settings" class="w-full text-left flex items-center gap-3 px-4 py-2 text-sm text-primary hover:bg-tertiary">
                           <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 21l-3.5-3.5C9.536 16.536 9 14.88 9 13.172V11c0-1.657 1.343-3 3-3h1c1.657 0 3 1.343 3 3v2.172c0 1.707-.536 3.364-1.5 4.328L14 21z"></path><path d="M12 11V5a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><circle cx="16" cy="5" r="1"></circle></svg>
                           Pengaturan API
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="p-4 sm:p-6 md:p-10 flex justify-center items-start min-h-[90vh]">
        <div id="device-preview-container" class="mx-auto main-card border-custom flex flex-col mobile-view">
            <div id="content-container" class="flex-grow p-4 sm:p-6 space-y-6">
                <div id="image-input-area">
                    <div class="text-center p-6 bg-secondary rounded-xl border-2 border-dashed border-custom flex flex-col items-center justify-center min-h-[200px] overflow-hidden">
                        <div id="image-placeholder" class="flex flex-col items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-secondary mx-auto mb-4"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                            <p class="text-primary font-semibold">Letakkan Gambar di Sini</p>
                            <p class="text-secondary text-sm mt-1">Tempel (Ctrl+V), unggah, atau gunakan kamera.</p>
                        </div>
                    </div>
                    <div class="mt-4 grid grid-cols-2 gap-3">
                        <button id="upload-image-btn" class="flex-1 flex items-center justify-center gap-2 py-3 px-3 text-sm font-semibold bg-tertiary text-primary rounded-lg hover:bg-slate-600 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.2 15c.7-1.2 1-2.5.7-3.9-.6-2.4-3-4-5.4-4-1.3 0-2.5.5-3.5 1.4-1-1.3-2.8-2-4.6-1.7-2.3.4-4.1 2.2-4.4 4.6-.3 2.1.8 4 2.3 5.2"></path><path d="M12 12v9"></path><path d="m16 16-4-4-4 4"></path></svg>
                            Unggah
                        </button>
                        <button id="use-camera-btn" class="flex-1 flex items-center justify-center gap-2 py-3 px-3 text-sm font-semibold bg-tertiary text-primary rounded-lg hover:bg-slate-600 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path><circle cx="12" cy="13" r="3"></circle></svg>
                            Kamera
                        </button>
                    </div>
                    <input type="file" id="image-upload-input" class="hidden" accept="image/*">
                </div>

                <div id="cropper-stage" class="hidden space-y-4">
                    <div id="image-cropper-container" class="bg-secondary rounded-xl border border-custom relative">
                        <img id="image-to-crop">
                        <div id="scan-overlay" class="hidden absolute inset-0 flex flex-col items-center justify-center overflow-hidden rounded-xl">
                            <div class="scan-line"></div>
                            <p class="text-accent text-sm font-semibold z-10">Mengekstrak Teks...</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                         <button id="reset-btn" class="flex-1 flex items-center justify-center gap-2 py-3 px-3 text-sm font-semibold bg-tertiary text-primary rounded-lg hover:bg-slate-600 transition-colors">
                            Batal
                        </button>
                        <button id="extract-btn" class="flex-1 flex items-center justify-center gap-2 py-3 px-3 text-sm font-bold text-white rounded-lg shadow-lg" style="background-image: var(--btn-accent-bg);">
                            Ekstrak Teks
                        </button>
                    </div>
                </div>

                <div class="bg-secondary rounded-xl shadow-lg border border-custom overflow-hidden">
                    <div class="p-4 flex justify-between items-center border-b border-custom">
                         <h2 class="text-lg font-bold text-accent">Hasil Ekstraksi</h2>
                         <div class="flex items-center gap-2">
                             <button id="revert-btn" class="hidden flex items-center gap-2 py-1 px-3 text-xs font-semibold bg-tertiary text-primary rounded-full hover:bg-slate-600 transition-colors" title="Kembali ke teks asli">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>
                                Asli
                             </button>
                             <button id="tidy-text-btn" class="flex items-center gap-2 py-1 px-3 text-xs font-semibold bg-tertiary text-primary rounded-full hover:bg-slate-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled title="Rapikan Paragraf Otomatis">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                                Rapikan
                             </button>
                             <button id="copy-text-btn" class="flex items-center gap-2 py-1 px-3 text-xs font-semibold bg-tertiary text-primary rounded-full hover:bg-slate-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled title="Salin Teks">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                                Salin
                             </button>
                         </div>
                    </div>
                    <div id="output-container" class="p-4 min-h-[150px]">
                        <p id="output-placeholder" class="text-secondary text-center p-10">Hasil teks akan muncul di sini.</p>
                        <div id="ocr-result" contenteditable="true" class="text-primary text-sm space-y-4 p-2 -m-2" style="display: none;"></div>
                    </div>
                </div>
            </div>

            <div id="api-settings-view" class="absolute top-0 left-0 w-full h-full bg-primary z-[55]">
                <div class="p-4 sm:p-6 h-full flex flex-col">
                    <div class="flex-shrink-0 flex items-center gap-4 mb-4 pb-4 border-b border-custom">
                        <button id="back-from-api-settings-btn" class="p-2 rounded-full hover:bg-tertiary transition-colors" title="Kembali">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"></path></svg>
                        </button>
                        <h2 class="text-lg font-bold text-accent">Pengaturan Kunci API</h2>
                    </div>
                    <div id="api-settings-content" class="flex-grow text-secondary text-sm space-y-6">
                        <p>Kunci API Anda disimpan dengan aman di browser Anda.</p>
                         <div>
                            <label for="api-key-input" class="block mb-2 text-sm font-medium text-primary">Kunci API Google AI</label>
                            <div class="flex items-end gap-2">
                                <input type="password" id="api-key-input" class="w-full bg-tertiary border border-custom rounded-lg p-3 text-primary focus:ring-2 focus:ring-accent" placeholder="AIzaSy...">
                                <button id="save-api-key-btn" class="flex-shrink-0 h-[46px] text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 flex items-center justify-center shadow-lg" style="background-image: var(--btn-accent-bg);">Simpan</button>
                            </div>
                            <p id="api-key-status" class="text-xs text-secondary mt-2">Masukkan kunci API pribadi Anda.</p>
                            <a href="https://aistudio.google.com/app/apikey" target="_blank" class="mt-2 inline-block text-xs text-accent hover:underline">Belum punya kunci? Dapatkan di sini →</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="snackbar"></div>

    <div id="camera-modal" class="fixed inset-0 z-[60] flex items-center justify-center p-4 hidden">
        <div class="bg-secondary rounded-xl shadow-lg border border-custom w-full max-w-lg overflow-hidden relative">
            <video id="camera-stream" class="w-full h-auto" autoplay playsinline></video>
            <div id="grid-overlay" class="absolute inset-0 pointer-events-none grid grid-cols-3 grid-rows-3">
                <div class="col-span-1 row-span-1 border-r border-b border-white/20"></div><div class="col-span-1 row-span-1 border-r border-b border-white/20"></div><div class="col-span-1 row-span-1 border-b border-white/20"></div><div class="col-span-1 row-span-1 border-r border-b border-white/20"></div><div class="col-span-1 row-span-1 border-r border-b border-white/20"></div><div class="col-span-1 row-span-1 border-b border-white/20"></div><div class="col-span-1 row-span-1 border-r border-white/20"></div><div class="col-span-1 row-span-1 border-r border-white/20"></div><div class="col-span-1 row-span-1"></div>
            </div>
            <div class="p-4 flex flex-col gap-3 absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/50 to-transparent">
                <button id="capture-btn" class="w-full text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 flex items-center justify-center gap-2 shadow-lg" style="background-image: var(--btn-accent-bg);">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path><circle cx="12" cy="13" r="3"></circle></svg>
                    Ambil Gambar
                </button>
                <button id="close-camera-btn" class="w-full font-semibold py-2 px-4 rounded-lg bg-tertiary/80 text-primary hover:bg-slate-600 transition-colors">Tutup</button>
            </div>
        </div>
    </div>
    <canvas id="camera-canvas" class="hidden"></canvas>

    <script type="module">
        const body = document.body;
        const ocrResult = document.getElementById('ocr-result');
        const outputPlaceholder = document.getElementById('output-placeholder');
        const copyTextBtn = document.getElementById('copy-text-btn');
        const apiKeyInput = document.getElementById('api-key-input');
        const apiKeyStatus = document.getElementById('api-key-status');
        const apiSettingsView = document.getElementById('api-settings-view');
        const cameraModal = document.getElementById('camera-modal');
        const videoElement = document.getElementById('camera-stream');
        const canvasElement = document.getElementById('camera-canvas');
        const captureBtn = document.getElementById('capture-btn');
        const useCameraBtn = document.getElementById('use-camera-btn');
        const closeCameraBtn = document.getElementById('close-camera-btn');
        const menuBtn = document.getElementById('menu-btn');
        const dropdownMenu = document.getElementById('dropdown-menu');
        const menuDeviceToggle = document.getElementById('menu-device-toggle');
        const menuThemeToggle = document.getElementById('menu-theme-toggle');
        const menuApiSettings = document.getElementById('menu-api-settings');
        const imageInputArea = document.getElementById('image-input-area');
        const cropperStage = document.getElementById('cropper-stage');
        const imageToCrop = document.getElementById('image-to-crop');
        const extractBtn = document.getElementById('extract-btn');
        const resetBtn = document.getElementById('reset-btn');
        const scanOverlay = document.getElementById('scan-overlay');
        const tidyTextBtn = document.getElementById('tidy-text-btn');
        const revertBtn = document.getElementById('revert-btn');
        let cropper = null;
        let currentStream = null;
        let originalOcrText = '';

        let snackbarTimeout;
        function showSnackbar(message) {
            const snackbar = document.getElementById('snackbar');
            clearTimeout(snackbarTimeout);
            snackbar.textContent = message; snackbar.className = 'show';
            snackbarTimeout = setTimeout(() => { snackbar.className = snackbar.className.replace('show', ''); }, 3000);
        }
        function applyClickFeedback(element) {
            if(!element) return;
            element.classList.add('btn-active-feedback');
            setTimeout(() => { element.classList.remove('btn-active-feedback'); }, 150);
        }

        menuBtn.addEventListener('click', (e) => { e.stopPropagation(); dropdownMenu.classList.toggle('hidden'); });
        document.addEventListener('click', () => { if (!dropdownMenu.classList.contains('hidden')) dropdownMenu.classList.add('hidden'); });
        function applyTheme(theme) { body.classList.toggle('light-theme', theme === 'light'); }
        menuThemeToggle.addEventListener('click', () => {
            const newTheme = body.classList.contains('light-theme') ? 'dark' : 'light';
            localStorage.setItem('theme', newTheme); applyTheme(newTheme); applyClickFeedback(menuThemeToggle);
        });
        let currentDeviceIndex = 0;
        const deviceStates = ['mobile-view', 'tablet-view', 'pc-view'];
        function applyDeviceView(index) {
            document.getElementById('device-preview-container').className = `mx-auto main-card border-custom flex flex-col ${deviceStates[index]}`;
            currentDeviceIndex = index;
        }
        menuDeviceToggle.addEventListener('click', () => { applyDeviceView((currentDeviceIndex + 1) % deviceStates.length); applyClickFeedback(menuDeviceToggle); });
        menuApiSettings.addEventListener('click', () => { apiSettingsView.classList.add('view-active'); });
        document.getElementById('back-from-api-settings-btn').addEventListener('click', () => apiSettingsView.classList.remove('view-active'));

        function loadApiKey() {
            const savedKey = localStorage.getItem('user_google_api_key');
            if (savedKey) {
                apiKeyInput.value = savedKey;
                apiKeyStatus.textContent = `Kunci tersimpan (berakhir dengan ...${savedKey.slice(-4)}).`;
                apiKeyStatus.style.color = 'var(--text-accent)';
            }
        }
        document.getElementById('save-api-key-btn').addEventListener('click', () => {
            const key = apiKeyInput.value.trim();
            if (key && key.startsWith('AIzaSy')) {
                localStorage.setItem('user_google_api_key', key);
                showSnackbar('Kunci API berhasil disimpan.'); loadApiKey();
                setTimeout(() => apiSettingsView.classList.remove('view-active'), 500);
            } else { showSnackbar('Format Kunci API tidak valid.'); }
        });
        
        function setUIState(state) {
            outputPlaceholder.classList.toggle('hidden', state === 'loading' || state === 'result' || state === 'tidied');
            ocrResult.style.display = (state === 'result' || state === 'tidied') ? 'block' : 'none';
            copyTextBtn.disabled = (state !== 'result' && state !== 'tidied');
            tidyTextBtn.disabled = (state !== 'result' && state !== 'tidied');
            
            if (state === 'result') {
                revertBtn.classList.add('hidden');
                tidyTextBtn.classList.remove('hidden');
            }
        }

        function renderMixedLanguageText(container, text, isTidied = false) {
            container.innerHTML = ''; 
            if (!text || typeof text !== 'string') return;
            const paragraphs = text.split('\n');
            paragraphs.forEach(paragraphText => {
                const p = document.createElement('p');
                p.textContent = paragraphText || '\u00A0'; 
                const isArabic = /^[\u0600-\u06FF]/.test(paragraphText.trim());
                if (isArabic) {
                    p.className = 'font-naskh text-right'; p.style.direction = 'rtl';
                } else {
                    p.className = 'font-sans text-left'; p.style.direction = 'ltr';
                }
                if(isTidied) { p.style.textAlign = 'justify'; }
                container.appendChild(p);
            });
        }
        
        async function openCamera() {
            if (!('mediaDevices' in navigator && 'getUserMedia' in navigator.mediaDevices)) { showSnackbar('Kamera tidak didukung.'); return; }
            cameraModal.classList.remove('hidden');
            try {
                currentStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                videoElement.srcObject = currentStream;
            } catch (err) { showSnackbar('Gagal mengakses kamera. Berikan izin.'); closeCamera(); }
        }
        function closeCamera() {
            if (currentStream) { currentStream.getTracks().forEach(track => track.stop()); }
            cameraModal.classList.add('hidden'); videoElement.srcObject = null;
        }
        captureBtn.addEventListener('click', () => {
            canvasElement.width = videoElement.videoWidth; canvasElement.height = videoElement.videoHeight;
            const context = canvasElement.getContext('2d');
            context.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
            canvasElement.toBlob(blob => {
                if (blob) {
                    const imageFile = new File([blob], `capture.png`, { type: 'image/png' });
                    loadImageForCropping(imageFile);
                }
            }, 'image/png');
            closeCamera();
        });
        
        function loadImageForCropping(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                imageInputArea.classList.add('hidden');
                cropperStage.classList.remove('hidden');
                imageToCrop.src = e.target.result;
                if (cropper) { cropper.destroy(); }
                cropper = new Cropper(imageToCrop, { viewMode: 1, background: false, autoCropArea: 0.8 });
            };
            reader.readAsDataURL(file);
        }
        extractBtn.addEventListener('click', () => {
            if (!cropper) return;
            scanOverlay.classList.remove('hidden');
            extractBtn.disabled = true; resetBtn.disabled = true;
            cropper.getCroppedCanvas().toBlob((blob) => {
                const croppedFile = new File([blob], 'cropped.png', { type: 'image/png' });
                performOCR(croppedFile);
            });
        });
        resetBtn.addEventListener('click', () => {
            if (cropper) { cropper.destroy(); cropper = null; }
            imageInputArea.classList.remove('hidden');
            cropperStage.classList.add('hidden');
            imageToCrop.src = '';
            setUIState('idle'); 
            originalOcrText = '';
        });

        async function performOCR(file) {
            if (!file) return;
            const apiKey = localStorage.getItem('user_google_api_key');
            if (!apiKey) { showSnackbar('Kunci API belum diatur.'); menuApiSettings.click(); return; }
            
            setUIState('loading');
            try {
                const base64Data = await new Promise((resolve, reject) => {
                    const reader = new FileReader(); reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = error => reject(error);
                });
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const payload = { contents: [{ parts: [{ text: "Extract text from this image. Provide only the extracted text." }, { inlineData: { mimeType: file.type, data: base64Data } }] }] };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.error.message || `API Error`); }
                const result = await response.json();
                const extractedText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (extractedText) {
                    originalOcrText = extractedText;
                    renderMixedLanguageText(ocrResult, extractedText, false);
                    showSnackbar('Teks berhasil diekstrak!');
                    setUIState('result');
                } else {
                    originalOcrText = '';
                    showSnackbar('Tidak ada teks yang ditemukan.');
                    setUIState('idle');
                }
            } catch (error) {
                showSnackbar(`Terjadi kesalahan: ${error.message}`);
                setUIState('idle');
            } finally {
                scanOverlay.classList.add('hidden');
                extractBtn.disabled = false; resetBtn.disabled = false;
            }
        }
        
        async function tidyUpText() {
            const currentText = ocrResult.innerText;
            if (!currentText) { showSnackbar("Tidak ada teks untuk dirapikan."); return; }
            const apiKey = localStorage.getItem('user_google_api_key');
            if (!apiKey) { showSnackbar('Kunci API belum diatur.'); menuApiSettings.click(); return; }

            tidyTextBtn.innerHTML = `<svg class="animate-spin h-3 w-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Merapikan...`;
            tidyTextBtn.disabled = true;

            const systemPrompt = "You are an expert text formatter. Your task is to intelligently merge lines into proper paragraphs. CRITICAL RULE: DO NOT merge lines that appear to be part of a list (e.g., starting with *, -, •, numbers like 1., or letters like a.). Preserve these as separate lines. For all other lines, merge them if they belong to the same paragraph by replacing the single newline with a space. DO NOT change, add, or delete any words. Output only the raw, corrected text.";
            
            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const payload = { contents: [{ parts: [{ text: currentText }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.error.message || `API Error`); }
                const result = await response.json();
                const tidiedText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (tidiedText) {
                    renderMixedLanguageText(ocrResult, tidiedText, true);
                    showSnackbar("Teks berhasil dirapikan!");
                    setUIState('tidied');
                    tidyTextBtn.classList.add('hidden');
                    revertBtn.classList.remove('hidden');
                } else { throw new Error("Gagal mendapatkan hasil dari AI."); }
            } catch (error) {
                showSnackbar(`Gagal merapikan teks: ${error.message}`);
            } finally {
                tidyTextBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg> Rapikan`;
                tidyTextBtn.disabled = false;
            }
        }
        
        revertBtn.addEventListener('click', () => {
            if(originalOcrText) {
                renderMixedLanguageText(ocrResult, originalOcrText, false);
                revertBtn.classList.add('hidden');
                tidyTextBtn.classList.remove('hidden');
                showSnackbar("Teks dikembalikan ke versi asli.");
            }
        });

        const uploadImageBtn = document.getElementById('upload-image-btn');
        const imageUploadInput = document.getElementById('image-upload-input');
        uploadImageBtn.addEventListener('click', () => imageUploadInput.click());
        imageUploadInput.addEventListener('change', (e) => e.target.files[0] && loadImageForCropping(e.target.files[0]));
        useCameraBtn.addEventListener('click', openCamera);
        closeCameraBtn.addEventListener('click', closeCamera);
        document.addEventListener('paste', (event) => {
            const items = (event.clipboardData || window.clipboardData).items;
            let imageFile = null;
            for (let i = 0; i < items.length; i++) { if (items[i].type.indexOf('image') !== -1) { imageFile = items[i].getAsFile(); break; } }
            if (imageFile) { event.preventDefault(); loadImageForCropping(imageFile); }
        });
        copyTextBtn.addEventListener('click', () => {
            if (ocrResult.innerText) {
                navigator.clipboard.writeText(ocrResult.innerText)
                    .then(() => showSnackbar('Teks berhasil disalin!'))
                    .catch(() => showSnackbar('Gagal menyalin teks.'));
                applyClickFeedback(copyTextBtn);
            }
        });
        tidyTextBtn.addEventListener('click', tidyUpText);

        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            applyTheme(savedTheme); applyDeviceView(0); loadApiKey(); setUIState('idle');
        });
    </script>
</body>
</html>
